# [SPX-001] Implement PlexEventLoop Core Structure

**Status:** PENDING
**Phase:** 1 - Event Loop Foundation
**Dependencies:** None (foundational ticket)

---

## Description

Create the basic PlexEventLoop structure with io_uring initialization and destruction. This establishes the foundation for the async event loop that will drive all Samplex operations.

## Definition of Done

- [x] File: `apps/spikes/samplex/src/plex_uring.c` created
- [x] File: `apps/spikes/samplex/src/plex_uring.h` created
- [ ] Functions implemented:
  - [ ] `plex_event_loop_create(PlexRegistry* registry)`
  - [ ] `plex_event_loop_destroy(PlexEventLoop* loop)`
- [ ] Includes proper Apache 2.0 license headers
- [ ] io_uring ring properly initialized with configurable queue depth
- [ ] Proper cleanup in destroy function
- [ ] Code compiles without warnings
- [ ] Basic validation test added to main.c

---

## 1. Discovery (Context Audit)

### Search for Similar Patterns
```bash
# Check for existing io_uring usage
grep -r "io_uring" apps/spikes/samplex/

# Check for existing Plex structures
grep -r "PlexRegistry" apps/spikes/samplex/
```

### Dependencies Verification
- **liburing**: Required for io_uring operations
  - Check: `pkg-config --exists liburing`
  - Header: `<liburing.h>`
- **PlexRegistry**: Existing structure from plex.h
- **SamArena**: Existing memory management

### File Location
- Headers: `apps/spikes/samplex/src/plex_uring.h` (internal use, not public API yet)
- Implementation: `apps/spikes/samplex/src/plex_uring.c`
- Update: `apps/spikes/samplex/CMakeLists.txt` to include new source file

---

## 2. Technical Design

### Data Structure
```c
// plex_uring.h
typedef struct PlexEventLoop {
    struct io_uring ring;           // io_uring instance
    PlexRegistry* registry;         // Reference to plex registry
    bool running;                   // Loop state flag
    SamArena* arena;                // Memory backing
    uint32_t queue_depth;           // CQ/SQ size
} PlexEventLoop;
```

### Function Signatures
```c
// Create event loop with specified queue depth
PlexEventLoop* plex_event_loop_create(PlexRegistry* registry, uint32_t queue_depth);

// Destroy event loop and cleanup resources
void plex_event_loop_destroy(PlexEventLoop* loop);
```

### Safety Considerations
- NULL pointer checks for registry parameter
- Validate queue_depth (reasonable bounds: 32-4096)
- Check io_uring_queue_init return value
- Ensure io_uring_queue_exit is called even on partial initialization failure
- Use arena allocation for PlexEventLoop structure itself

### Naming Conventions
- Prefix: `plex_event_loop_` for all public functions
- Prefix: `plex_` for internal helpers if needed
- Struct name: `PlexEventLoop` (PascalCase)
- Follow existing Plex patterns from plex.h

---

## 3. Step-by-Step Execution Plan

### Step 1: Create plex_uring.h header
- [ ] Add Apache 2.0 license header
- [ ] Add include guards: `PLEX_URING_H`
- [ ] Include dependencies: `<liburing.h>`, `"plex.h"`
- [ ] Define `PlexEventLoop` struct
- [ ] Declare `plex_event_loop_create()` prototype
- [ ] Declare `plex_event_loop_destroy()` prototype

### Step 2: Create plex_uring.c implementation
- [ ] Add Apache 2.0 license header
- [ ] Include `plex_uring.h`
- [ ] Include necessary system headers (`<stdlib.h>`, `<string.h>`, etc.)

### Step 3: Implement plex_event_loop_create()
- [ ] Validate input parameters (registry != NULL)
- [ ] Validate queue_depth (clamp to 32-4096 range)
- [ ] Allocate PlexEventLoop from registry's arena (or create temp arena)
- [ ] Initialize io_uring with `io_uring_queue_init()`
- [ ] Handle initialization failure (cleanup and return NULL)
- [ ] Set initial state: `running = false`
- [ ] Store registry reference
- [ ] Return initialized loop

### Step 4: Implement plex_event_loop_destroy()
- [ ] Check for NULL loop pointer
- [ ] Call `io_uring_queue_exit(&loop->ring)`
- [ ] Clear registry reference
- [ ] Free PlexEventLoop (if not arena-managed, handle appropriately)

### Step 5: Update CMakeLists.txt
- [ ] Add `src/plex_uring.c` to sources list
- [ ] Ensure `uring` target is linked
- [ ] Verify build succeeds

### Step 6: Add basic test in main.c
- [ ] Create PlexRegistry
- [ ] Call plex_event_loop_create()
- [ ] Verify non-NULL return
- [ ] Call plex_event_loop_destroy()
- [ ] Clean up registry
- [ ] Print success message

---

## 4. Implementation

Execute the plan from Step 3. Check off items as completed.

---

## 5. Verification (The "Must-Haves")

### Build Test
```bash
cd build
cmake ..
make samplex
```
- [ ] Compiles without errors
- [ ] Compiles without warnings (-Wall -Wextra)

### Usage Test
```bash
./build/apps/spikes/samplex/samplex
```
- [ ] Runs without crashes
- [ ] Creates event loop successfully
- [ ] Destroys event loop cleanly
- [ ] No memory leaks (optional: run with valgrind)

### Sanity Check
- [ ] Matches Technical Design from Step 2
- [ ] Follows ptah naming conventions (plex_ prefix)
- [ ] Uses existing PlexRegistry pattern
- [ ] Proper error handling on io_uring init failure

### Cleanup
- [ ] Remove any debug printf statements
- [ ] Remove any commented-out code
- [ ] Ensure consistent formatting

---

## 6. Completion

- [ ] Mark this ticket as **DONE** in tracking document
- [ ] Update `planning/active/samplex_async_engine.md` progress
- [ ] Ready to proceed to [SPX-002]
